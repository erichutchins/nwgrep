name: CI

on:
  pull_request:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  lint:
    name: Lint and Type Check
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v6
      
      - uses: astral-sh/setup-uv@v7
        with:
          python-version: "3.12"
          enable-cache: true
      
      - name: Set up Python
        run: uv python install
      
      - name: Install dependencies
        run: uv sync --group lint
      
      - name: Run ruff format check
        run: uv run --locked ruff format --check src/nwgrep
      
      - name: Run ruff lint
        run: uv run --locked ruff check src/nwgrep
      
      - name: Run ty
        run: uvx ty check src/nwgrep

  test:
    name: Test Python ${{ matrix.python-version }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ["3.10", "3.11", "3.12", "3.13", "3.14"]
        exclude:
          # Python 3.13+ has numpy compatibility issues on Windows
          - os: windows-latest
            python-version: "3.13"
          - os: windows-latest
            python-version: "3.14"

    steps:
      - uses: actions/checkout@v6
      
      - uses: astral-sh/setup-uv@v7
        with:
          python-version: ${{ matrix.python-version }}
          enable-cache: true
          cache-dependency-glob: |
            pyproject.toml
            uv.lock
      
      - name: Set up Python ${{ matrix.python-version }}
        run: uv python install
      
      - name: Install dependencies
        run: |
          uv sync --group dev
      
      - name: Run tests
        run: |
          uv run --locked pytest -v --cov=nwgrep --cov-report=xml --cov-report=term-missing
        env:
          PYTHONUTF8: "1"  # Forces UTF-8 encoding for Python on Windows
          PYTHONIOENCODING: "utf-8"  # Ensures I/O uses UTF-8

  test-backends:
    name: Test ${{ matrix.backend }} backend
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        backend: [pandas, polars, pyarrow]
    
    steps:
      - uses: actions/checkout@v6
      
      - uses: astral-sh/setup-uv@v7
        with:
          python-version: "3.12"
          enable-cache: true
          cache-suffix: ${{ matrix.backend }}
      
      - name: Set up Python
        run: uv python install
      
      - name: Install dependencies with test backends
        run: uv sync --group test-backends --group tests
      
      - name: Show installed versions
        run: |
          echo "Testing with ${{ matrix.backend }}:"
          uv run --locked python -c "import ${{ matrix.backend }}; print(f'${{ matrix.backend }} version: {${{ matrix.backend }}.__version__}')"
          uv run --locked python -c "import narwhals; print(f'narwhals version: {narwhals.__version__}')"
      
      - name: Run backend-specific tests
        run: |
          # Run all tests but they'll use the specific backend
          uv run --locked pytest -v tests/ -k "${{ matrix.backend }} or not (pandas or polars or pyarrow)"

  test-features:
    name: Test ${{ matrix.feature }} feature
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        feature: [cli, notebook]
    
    steps:
      - uses: actions/checkout@v6
      
      - uses: astral-sh/setup-uv@v7
        with:
          python-version: "3.12"
          enable-cache: true
          cache-suffix: ${{ matrix.feature }}
      
      - name: Set up Python
        run: uv python install
      
      - name: Install with ${{ matrix.feature }} extra
        run: |
          uv sync --extra ${{ matrix.feature }} --group tests --group test-backends
      
      - name: Test ${{ matrix.feature }} functionality
        run: |
          case "${{ matrix.feature }}" in
            cli)
              # Test CLI works
              uv run --locked nwgrep --help
              # Create test file and run CLI
              uv run --locked python -c "import polars as pl; pl.DataFrame({'col': ['foo', 'bar']}).write_parquet('test.parquet')"
              uv run --locked nwgrep "foo" test.parquet
              ;;
            notebook)
              # Test great-tables import
              uv run --locked python -c "import great_tables; print('great-tables OK')"
              # Run notebook-specific tests if you have them
              uv run --locked pytest -v tests/ -k "highlight or style"
              ;;
          esac

  # Optional: Test that base install works without any extras
  test-minimal:
    name: Test minimal install (no extras)
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v6
      
      - uses: astral-sh/setup-uv@v7
        with:
          python-version: "3.12"
          enable-cache: true
      
      - name: Set up Python
        run: uv python install
      
      - name: Install minimal (just narwhals)
        run: uv sync --no-default-groups
      
      - name: Test core import works
        run: |
          uv run --locked --no-default-groups python -c "from nwgrep import nwgrep; print('✓ Core import works')"
          uv run --locked --no-default-groups python -c "from nwgrep import register_grep_accessor; print('✓ Accessor import works')"
      
      - name: Verify CLI is NOT av ailable (requires cli extra)
        run: |
          # This should fail since we didn't install [cli]
          ! uv run --locked --no-default-groups nwgrep --help 2>/dev/null || (echo "ERROR: CLI should not work without [cli] extra" && exit 1)

  # Optional: Test against latest narwhals development version
  test-narwhals-main:
    name: Test with narwhals main branch
    runs-on: ubuntu-latest
    continue-on-error: true  # Don't fail CI if narwhals dev has breaking changes
    
    steps:
      - uses: actions/checkout@v6
      
      - uses: astral-sh/setup-uv@v7
        with:
          python-version: "3.12"
      
      - name: Install dependencies
        run: uv sync --group dev
      
      - name: Install narwhals from main
        run: |
          uv pip install git+https://github.com/narwhals-dev/narwhals.git
      
      - name: Run tests
        run: uv run --locked pytest -v